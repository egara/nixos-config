# Gemini Agent Context for nixos-config

This document serves as the primary context and knowledge base for the Gemini CLI agent operating within the `nixos-config` repository. It outlines the project's architecture, key components, and operational workflows.

## 1. Project Philosophy & Goal

This repository is a **NixOS Flake** configuration that manages multiple machines (hosts). The primary goal is to provide a reproducible, declarative system configuration with a focus on a custom, polished desktop environment named **SicOS**.

**Core Principles:**
- **Pure Flakes:** All configurations are driven by `flake.nix`.
- **Modularity:** Configuration is split into `hosts`, `modules` (system-level), and `home-manager` (user-level).
- **SicOS:** A custom Hyprland-based desktop environment module that can be imported by any NixOS system.
- **Theming:** Integrated Light/Dark mode switching using `Stylix`.

## 2. Architecture & Directory Structure

- **`flake.nix`**: The entry point. Defines inputs (NixOS, Home Manager, Stylix, etc.) and outputs (`nixosConfigurations`, `nixosModules`, `homeManagerModules`).
- **`hosts/`**: Contains machine-specific configurations.
    - `default.nix`: Logic to generate `nixosConfigurations` for all hosts.
    - `<hostname>/`: Directory for each machine (e.g., `ironman`, `rocket`, `strange`, `vm`).
        - `configuration.nix`: Main system configuration for the host.
        - `hardware-configuration.nix`: Hardware-specific settings.
        - `disko-config.nix`: Disk partitioning layout (managed by Disko).
- **`modules/`**: Custom NixOS modules.
    - `sicos/hyprland/`: **The core SicOS module.**
        - `default.nix`: Defines module options (`programs.sicos.hyprland.*`) and system-level config.
        - `hm-module.nix`: The Home Manager companion module, handling user-specific config and Stylix integration.
        - `config-files/`: Raw configuration files for Hyprland, Waybar, etc.
        - `scripts/`: Helper scripts deployed to the system.
- **`home-manager/`**: User-specific configurations (dotfiles) not strictly tied to the SicOS module but used in the broader configuration.
    - `desktop/hyprland/scripts/theme-switcher.sh`: The master script for toggling themes.

## 3. Key Components

### 3.1. SicOS Module
**Location:** `modules/sicos/hyprland/`

SicOS provides a complete desktop experience. It is split into two parts:
1.  **NixOS Module (`default.nix`)**: Installs packages (Hyprland, Waybar, SDDM), enables system services (power profiles, polkit), and defines the `programs.sicos.hyprland` options.
2.  **Home Manager Module (`hm-module.nix`)**: Manages dotfiles (`.config/hypr/...`, `.config/waybar/...`) and integrates with **Stylix** for theming.

**Key Options:**
- `enable`: Activate the module.
- `theming.mode`: `"light"` or `"dark"`.
- `powerManagement.enable`: Optimizations for laptops (affects Waybar config).
- `insync.enable`: Custom tray integration for Insync.

### 3.2. Theming & Stylix
Theming is handled by **Stylix** (via `hm-module.nix`) and a custom switcher script.
- **Stylix**: Sets the global color scheme (Base16), fonts, and cursor. It automatically themes applications like Kitty, GTK, and builds the color palette.
- **Switching Mechanism**:
    1.  User runs `theme-switcher.sh [light|dark]`.
    2.  Script finds the file defining `theming.mode` (usually in `hosts/<host>/configuration.nix` or similar).
    3.  Script updates the Nix file using `sed`.
    4.  Script runs `nixos-rebuild switch`.
    5.  Script reloads UI components (Waybar, SwayNC, Walker) to apply changes immediately without logout.

### 3.3. Hosts
- **VM (`vm`)**: QEMU virtual machine for testing.
- **Rocket (`rocket`)**: Desktop PC (custom build).
- **Ironman (`ironman`)**: Laptop (Intel/Nvidia).
- **Taskmaster (`taskmaster`)**: Work Laptop.
- **Strange (`strange`)**: Framework Laptop 13 (AMD Ryzen AI 300).

## 4. Operational Workflows for the Agent

### 4.1. Modifying the Desktop Environment (SicOS)
**Goal:** Change how the desktop looks or behaves (e.g., Waybar, Hyprland).
1.  **Identify Component:** Is it a system package (edit `default.nix`) or a user config/dotfile (edit `hm-module.nix` or `config-files/`)?
2.  **Edit Config:**
    - If modifying `waybar/config.jsonc`, check if you need to edit the `powermanagement` or `no-powermanagement` version.
    - If adding a new keybinding, edit `hyprland-with-kanshi.conf` (or `without`).
3.  **Apply:** Run `nixos-rebuild switch --flake .#<hostname>`.

### 4.2. Adding a New Package
- **System-wide:** Edit `hosts/<host>/configuration.nix` (or `modules/sicos/hyprland/default.nix` if it should be in SicOS) and add to `environment.systemPackages`.
- **User-specific:** Edit `home-manager/users/<user>.nix` (or `hosts/home.nix` if shared) and add to `home.packages`.

### 4.3. Creating a New Host
1.  Create `hosts/<new-host>/`.
2.  Add `hardware-configuration.nix` (usually generated by `nixos-generate-config`).
3.  Add `configuration.nix` (importing SicOS and hardware config).
4.  Add `disko-config.nix` (if managing disks).
5.  Update `hosts/default.nix` to include the new host in `flake.nix` outputs.

## 5. File Map

| Path | Description |
| :--- | :--- |
| `flake.nix` | Project root, dependencies, outputs. |
| `modules/sicos/hyprland/default.nix` | SicOS System Module (Packages, Services, Options). |
| `modules/sicos/hyprland/hm-module.nix` | SicOS Home Manager Module (Dotfiles, Stylix). |
| `modules/sicos/hyprland/config-files/` | Raw config files for Hyprland, Waybar, etc. |
| `home-manager/desktop/hyprland/scripts/theme-switcher.sh` | Theme switching logic. |
| `hosts/` | Machine definitions. |

## 6. General Rules & Style Guide

### 6.1. General Rules
- **Language:** All generated code and comments must be in English.
- **Existing Comments:** Do not delete existing comments in the code.
- **Comment Placement:** All comments must be placed on the line immediately preceding the code they describe.

### 6.2. Style Guidelines
- **Nix Formatting:** Use standard formatting (2 spaces indentation).
- **Comments Content:** Explain *why* something is done, not just *what* is done.
- **Commit Messages:** Use clear, concise messages describing the change.